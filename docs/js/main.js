"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ready(){var e=new Birds($("#main-container")[0]);e.startAnimation(),e.setBirdNumber(768)}document.addEventListener("DOMContentLoaded",ready);var Birds=function(e,t){var i=this;i.container=e,i.playing=!1,i.WIDTH=t||32,i.BIRDS=i.WIDTH*i.WIDTH,THREE.BirdGeometry=function(){var e=3*i.BIRDS,t=3*e;THREE.BufferGeometry.call(this);var r=new THREE.BufferAttribute(new Float32Array(3*t),3),o=new THREE.BufferAttribute(new Float32Array(3*t),3),n=new THREE.BufferAttribute(new Float32Array(2*t),2),a=new THREE.BufferAttribute(new Float32Array(t),1);this.addAttribute("position",r),this.addAttribute("birdColor",o),this.addAttribute("reference",n),this.addAttribute("birdVertex",a);var s=0;function l(){for(var e=0;e<arguments.length;e++)r.array[s++]=arguments[e]}for(var h=0;h<i.BIRDS;h++)l(0,-0,-20,0,4,-20,0,0,30),l(0,0,-15,-20,0,0,0,0,15),l(0,0,15,20,0,0,0,0,-15);for(s=0;s<3*e;s++){var d=~~(s/3),u=d%i.WIDTH/i.WIDTH,m=~~(d/i.WIDTH)/i.WIDTH,c=new THREE.Color(4473924+~~(s/9)/i.BIRDS*6710886);o.array[3*s+0]=c.r,o.array[3*s+1]=c.g,o.array[3*s+2]=c.b,n.array[2*s]=u,n.array[2*s+1]=m,a.array[s]=s%9}this.scale(.2,.2,.2)},THREE.BirdGeometry.prototype=Object.create(THREE.BufferGeometry.prototype),i.container,i.camera,i.scene,i.renderer,i.geometry,i.mouseX=0,i.mouseY=0,i.windowHalfX=window.innerWidth/2,i.windowHalfY=window.innerHeight/2,i.BOUNDS=800,i.BOUNDS_HALF=i.BOUNDS/2,i.last=performance.now(),i.gpuCompute,i.velocityVariable,i.positionVariable,i.positionUniforms,i.velocityUniforms,i.birdUniforms,i.init()};Birds.prototype.setBirdNumber=function(e){e=~~(e/3);this.BIRDS=e,this.container.innerHTML="",this.init(),e<100?$("#main-container canvas").css({filter:"grayscale(0)"}):$("#main-container canvas").css({filter:"grayscale(100%)"})},Birds.prototype.init=function(){this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,3e3),this.camera.position.z=350,this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(16645626,100,1e3),this.renderer=new THREE.WebGLRenderer({antialias:!0,clearAlpha:1}),this.renderer.setClearColor(this.scene.fog.color),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.container.appendChild(this.renderer.domElement),this.initComputeRenderer();var e=this,t=function(t){e.onDocumentMouseMove.call(e,t)},i=function(t){e.onWindowResize.call(e,t)};document.addEventListener("mousemove",t,!1),document.addEventListener("touchstart",t,!1),document.addEventListener("touchmove",t,!1),window.addEventListener("resize",i,!1),window.addEventListener("orientationchange",i,!1),this.initBirds()},Birds.prototype.initComputeRenderer=function(){this.gpuCompute=new GPUComputationRenderer(this.WIDTH,this.WIDTH,this.renderer);var e=this.gpuCompute.createTexture(),t=this.gpuCompute.createTexture();this.fillPositionTexture(e),this.fillVelocityTexture(t),this.velocityVariable=this.gpuCompute.addVariable("textureVelocity",document.getElementById("fragmentShaderVelocity").textContent,t),this.positionVariable=this.gpuCompute.addVariable("texturePosition",document.getElementById("fragmentShaderPosition").textContent,e),this.gpuCompute.setVariableDependencies(this.velocityVariable,[this.positionVariable,this.velocityVariable]),this.gpuCompute.setVariableDependencies(this.positionVariable,[this.positionVariable,this.velocityVariable]),this.positionUniforms=this.positionVariable.material.uniforms,this.velocityUniforms=this.velocityVariable.material.uniforms,this.positionUniforms.time={value:0},this.positionUniforms.delta={value:0},this.velocityUniforms.time={value:1},this.velocityUniforms.delta={value:0},this.velocityUniforms.testing={value:1},this.velocityUniforms.seperationDistance={value:1},this.velocityUniforms.alignmentDistance={value:1},this.velocityUniforms.cohesionDistance={value:1},this.velocityUniforms.freedomFactor={value:1},this.velocityUniforms.predator={value:new THREE.Vector3},this.velocityVariable.material.defines.BOUNDS=this.BOUNDS.toFixed(2),this.velocityVariable.wrapS=THREE.RepeatWrapping,this.velocityVariable.wrapT=THREE.RepeatWrapping,this.positionVariable.wrapS=THREE.RepeatWrapping,this.positionVariable.wrapT=THREE.RepeatWrapping;var i=this.gpuCompute.init();null!==i&&console.error(i)},Birds.prototype.initBirds=function(){this.geometry=new THREE.BirdGeometry,this.birdUniforms={color:{value:new THREE.Color(16720384)},texturePosition:{value:null},textureVelocity:{value:null},time:{value:1},delta:{value:0}};var e=new THREE.ShaderMaterial({uniforms:this.birdUniforms,vertexShader:document.getElementById("birdVS").textContent,fragmentShader:document.getElementById("birdFS").textContent,side:THREE.DoubleSide});birdMesh=new THREE.Mesh(this.geometry,e),birdMesh.rotation.y=Math.PI/2,birdMesh.matrixAutoUpdate=!1,birdMesh.updateMatrix(),this.scene.add(birdMesh)},Birds.prototype.fillPositionTexture=function(e){for(var t=e.image.data,i=0,r=t.length;i<r;i+=4){var o=Math.random()*this.BOUNDS-this.BOUNDS_HALF,n=Math.random()*this.BOUNDS-this.BOUNDS_HALF,a=Math.random()*this.BOUNDS-this.BOUNDS_HALF;t[i+0]=o,t[i+1]=n,t[i+2]=a,t[i+3]=1}},Birds.prototype.fillVelocityTexture=function(e){for(var t=e.image.data,i=0,r=t.length;i<r;i+=4){var o=Math.random()-.5,n=Math.random()-.5,a=Math.random()-.5;t[i+0]=10*o,t[i+1]=10*n,t[i+2]=10*a,t[i+3]=1}},Birds.prototype.onWindowResize=function(){this.windowHalfX=window.innerWidth/2,this.windowHalfY=window.innerHeight/2,this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)},Birds.prototype.onDocumentMouseMove=function(e){"object"===_typeof(e.touches)&&1===e.touches.length?(e.preventDefault(),this.mouseX=e.touches[0].pageX-this.windowHalfX,this.mouseY=e.touches[0].pageY-this.windowHalfY):(this.mouseX=e.clientX-this.windowHalfX,this.mouseY=e.clientY-this.windowHalfY)},Birds.prototype.startAnimation=function(){!0!==this.playing&&(this.playing=!0,console.log("START BIRDS"),this.animate())},Birds.prototype.stopAnimation=function(){!1!==this.playing&&(this.playing=!1,console.log("STOP BIRDS"))},Birds.prototype.animate=function(){var e=this;!1!==this.playing&&(requestAnimationFrame(function(){e.animate.call(e)}),this.render())},Birds.prototype.render=function(){var e=performance.now(),t=(e-this.last)/1e3;t>1&&(t=1),this.last=e,this.positionUniforms.time.value=e,this.positionUniforms.delta.value=t,this.velocityUniforms.time.value=e,this.velocityUniforms.delta.value=t,this.birdUniforms.time.value=e,this.birdUniforms.delta.value=t,this.velocityUniforms.predator.value.set(.5*this.mouseX/this.windowHalfX,-.5*this.mouseY/this.windowHalfY,0),this.mouseX=1e4,this.mouseY=1e4,this.gpuCompute.compute(),this.birdUniforms.texturePosition.value=this.gpuCompute.getCurrentRenderTarget(this.positionVariable).texture,this.birdUniforms.textureVelocity.value=this.gpuCompute.getCurrentRenderTarget(this.velocityVariable).texture,this.renderer.render(this.scene,this.camera)};